# はじめに
このドキュメントは SXSW での竹あかり展示に用いる明かりモジュールの設定と操作について説明したものです。

2018/03/02
Shinobu Izumi (stagesp1@gmail.com)

# Macのログイン
アカウント：SXSW （管理者）

パスワード：sxsw

# 1. ハードウェア設定

## Arduinoの設定
Arduinoモジュールには明かり制御のためのプログラムが書き込み済み。
明かりを制御するグループごとにIDを割り振る必要がある。

事前の予定に基づいてIDを割り振っていますが、現場での個数の変更や故障などがあった場合は、適宜IDを振り直してください。

### Arduinoの接続


![](assets/README-0d398.png)

シリアルケーブルを接続します。

![](assets/README-6087d.png)

![](assets/README-5db08.png)

逆には刺さらないのでご安心。

### 明かりモジュールへのXBeeの接続

![](assets/README-59ff0.png)

明かりモジュールにXBeeを接続する。

足が曲がりやすいので、なるべくまっすぐに上からさせるように気をつけて作業すること。

![](assets/README-5719c.png)

XBeeは写真の向きとおなじになるように。
（逆に挿してもすぐに故障はしません）

次のArduinoの設定はXBeeを付けたままで行えます。

### Arduino IDEを用いた設定
![](assets/image-f38efeca.png)

Arudion IDEを起動する

![](assets/image-03548ca6.png)

![](assets/image-30e95ef6.png)

メニューのツールからボード Arduino/Genuino Uno を選択する

![](assets/image-0f1cdffc.png)

メニューのツールからシリアルポートを選択する
/dev/cu.usbserial-XXXXXXXXX

![](assets/image-b6b2c640.png)

メニューのツールからシリアルモニタを選択する

![](assets/image-45642f09.png)

右下の通信速度を 57600 bps にする

```
-- setup start --
please input ID. within 5000 ms.
```

が表示されてから５秒間がID設定モードとなる。
ここで、上部の入力ボックスに数字を入力して送信（エンター）すると、それがIDとして設定される。

５秒間に入力できなかった場合や間違えた場合は、シリアルモニタを閉じてメニューから再度開く。

![](assets/image-9045f8db.png)

５秒が経過すると、現在のIDが表示される。

### IDについて
明かりモジュールのIDごとに、明かりの色を制御するデータが送られるため、同一のIDを持つモジュールは同様の色変化をする。
複数のモジュールに共通のIDを設定することで、それらを同期的に色変化させられる。

## XBeeの設定
設定済みのため基本的には行わなくて大丈夫です。

### コンピュータに接続

![](assets/README-1ce5e.png)

![](assets/README-aed54.png)

XBeeのアダプタをUSBで接続し、アダプタにXBeeを付けます。

![](assets/README-ed45c.png)

電波の飛距離を出すためにアンテナを接続します。

### XCTUを用いた設定

![](assets/test-7cde1c86.png)

XCTUを起動する

![](assets/test-0ad48ed9.png)

右上の虫眼鏡アイコンをクリック

![](assets/test-1eebcf11.png)

usbserial-XXXXXXXXX のような名前のものをチェックして Next

![](assets/test-bf0c699c.png)

探す対象のXBeeの設定を選んで Finish
（通常は画像の設定で大丈夫です）

![](assets/test-1e3b4bac.png)

見つかったものを選択して Add selected devices

![](assets/test-a4394467.png)

追加されたものを選択するとXBeeモジュールの設定内容が表示される

CHがC、IDが3332、DHが0、DLがFFFF、BDが19200、APがAPI disabled[0]であることを確認する。異なっている場合は設定して右側の鉛筆ボタンで書き込み。

（注）XBeeが通信を受信していると読み出しや書き込みが上手くできない事があるので、設定するときは送信しているXBeeを止めてから行うと良い。マイクなどの電波と干渉することもあるが、その場合は場所を変えるなどで頑張る。

![](assets/test-5ecd4fef.png)

設定中にXBeeが抜けるなどでXBeeの状態が不正になった場合は読み出し、書き込みができなくなる。その場合は、上部のスパナアイコンからXBee Recoveryを選択。

![](assets/test-4f83e124.png)

図のように選択し、Recoverをクリックすると大体復活する。
Firmwareは最新ではなく10edであることに注意。

### チャンネルについて
CH - チャンネル
これと、IDが同じXBeeは通信することができる。送出と受信両方のXBeeを同じチャネルとIDに設定すること。

通信速度の関係で、１つのチャネルで最大１３グループの明かりモジュールを制御できる。１３グループを超える場合は送出のXBeeを増やし、チャンネルを分ける。

## 電池の接続と電源

![](assets/README-38c41.png)

![](assets/README-4959b.png)

電池をコネクタに接続します。ケーブル部分を引っ張らないように気をつけて付け外ししてください。

![](assets/README-10154.png)

電池接続時は、側面のスイッチをExtにするとOff、BattにするとOnになる。電源投入５秒後にモジュールが一度光る。強い光が出て眩しいため、ティッシュペーパーを上に載せる、手で遮るなどすると良い。

# 2. プログラムの起動と操作

今回は３つのプログラムを、それぞれ開発環境から起動する。

#### プログラムA. Bibbleと接続してボタン操作などを受け取る
XCodeから起動する。
プログラムCと接続してボタン操作などを中継する。

#### プログラムB. XBeeと接続して色制御情報を送出する
Eclipseから起動する。
プログラムCから接続され色情報を送出する。

#### プログラムC. 色の変化を制御する
Unityから起動する。プログラムAからの情報を受け取りプログラムBに送り出す。
UIを用いて色の変化をテストする。

次に、それぞれの起動と使い方を説明する。どのプログラムも不具合を感じたら、終了、または、強制終了して問題ない。

基本的にどの順番で起動しても問題ないはずだが、以下の手順（A→B→C）で起動することを推奨する。

## プログラムA
![](assets/image-30f3d3cb.png)

XCodeを起動する。

![](assets/image-43afa7c1.png)

TakeakariBibbleを選択（ダブルクリック）

![](assets/image-60d0d495.png)

左上の再生ボタンをクリックするとビルドと実行が行われる。

![](assets/image-942d87a7.png)

上のようなアプリが起動し、近くにあるBibbleを見つけてリスト表示する。

リストから接続したいBibbleの行をクリックすると、選択したBibbleのボタン操作、距離情報をプログラムBに送出し始める。
（プログラムBは後で起動して良い）

![](assets/image-4a144f31.png)

選択したものは名前左に (o) が付加される。数秒程度かかる場合が多いので、焦らず待つ。

![](assets/image-872008be.png)

接続したBibbleのボタンを操作すると、短いクリック、長いクリックそれぞれが行われた時間が行に表示される。

## プログラムB

これ以降は、XBeeをPCにUSB接続した状態で行うこと。
（後でUSB接続しても大きな問題はない）

![](assets/image-d053a153.png)

Eclipseを起動する。

![](assets/image-2a40188f.png)

プロジェクトが開いた状態で起動する。

![](assets/image-04733e5b.png)

右上の緑の再生ボタンをクリックするとプログラムが起動する。
（無視マークの右側）

![](assets/image-dfc8506d.png)

上部入力ボックスに入力されているのがPCがXBeeと通信をするために用いるシリアルポートである。接続するアダプタによって異なるため、場合によっては書き換える必要がある。

シリアルポートの調べ方は後に記述する。

Start Serverボタン（中央部全体どこでも）をクリックすると、プログラムCからの接続を待ち受けるサーバが起動する。

表示がStop Serverになっているはずなので、もう一度押すとサーバが停止する。

![](assets/image-869859cb.png)

操作を受け付けないなどの状態になったときは、Eclipse右下の赤い停止ボタンで強制停止できる。

### シリアルポートの調べ方

XBeeをUSB接続した状態で行うこと。

![](assets/image-d429feac.png)

ターミナルを開く

![](assets/image-85fdca58.png)

ls /dev/tty.usb と入力してキーボードのTabを押す。

![](assets/image-7bd24175.png)

残り部分が保管されポートがわかる。

## プログラムC

![](assets/image-231216bd.png)

Unityを起動する。

![](assets/image-5023c527.png)

Takeakari-Systemを選択する。

![](assets/image-fb634c99.png)

Unityが起動したら上部の再生ボタンをクリックする。

![](assets/image-c6d69373.png)

中央の画面が全体に拡大され実行状態になる。

### Bibbleデータの受信確認

左側のBibbleアイコンをクリックする

![](assets/image-fa5bf864.png)

画面下部に表示されたウィンドウの Listen をチェックする
（これでプログラムAからの接続とデータを受け入れる状態になる）

![](assets/image-bcbc1af4.png)

暫く待つと、Biblleの情報が表示される

左からBibbleのUID, 概算距離、ボタン操作

ここで、２行以上表示されている場合は、プログラムAにおいて、Bibbleが複数選択されているとかんがえられるので、Listenをチェックを外して停止、プログラムAを停止して再度操作、Listenを再度チェックとすると良い。

![](assets/image-1fc87c14.png)

Bibbleを操作して右のボタン状態表示が変化することを確認する。短いボタン操作は 1@時刻、長いボタン操作は 2@時刻 と表示される。

### 色変化の確認

左側のコントロールパネルアイコンをクリックする

![](assets/image-37c1bd20.png)

右側にコントロールが表示され、画面中央の色変化が始まる。

![](assets/image-dc7e5e09.png)

ここで再度Bibbleのボタン操作を行うと、明かりが変化する。

![](assets/image-ab269603.png)

右側の白地部分で現在のモードがわかる。短いクリックでモードが順番に変化。長いクリックをするとRandom Autoモードになる。

クリック操作を１００％受け取れるわけではないので、変化が無いときは数回クリックするなどしてください。

### プログラムBとの接続

![](assets/image-2b830bcb.png)

右上の Connect To ServerをクリックするとプログラムBに接続し、色情報の送出が始まる。
（明かりモジュールの電源が入っていれば、明かりが変化する）

画面中央部の明かりそばに表示されている数字は明かりモジュールのIDである。

![](assets/image-d979fcfe.png)

テストシーケンスを実行すると、モジュールIDの順に明かりが点灯するので確認すると良い。

![](assets/image-65ccc3bd.png)

コントロールパネルの緑枠部分 Speed は、色の変化速度を制御する。Lightは現状では操作しても何も効果はない。

## 各ソフトウェアの停止
AはXCode上の再生ボタン右の停止ボタン、Bは通常の左上の閉じるボタン、Cは再生ボタンをもう一度クリック（青から灰色に変化）

各開発ツールは起動しっぱなしでMacの画面を閉じて問題ありません。

## あとがき
複雑なので、１つづつ動いていることを確認しながらすすめるのが成功のコツです。
